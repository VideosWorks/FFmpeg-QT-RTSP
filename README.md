/*--------------------------------------2018年1月19日 更新水下机器人姿态显示界面-----------------------------------------*/

#基于Qt和FFmpeg的摄像头实时读取、显示及光源识别软件

本软件利用C++语言编写，借助于Qt5.9.1实现多线程和界面的设计，借助于FFmpeg2.5.2多媒体开源库实现了摄像头视频流的解码。最后，利用msvc2015(32bit)编译，借助于Enigma Virtual Box7.9程序打包软件打包而成。

1、软件功能：
（1）实时读取摄像头视频流，并显示；
（2）给摄像头视频流加上红色滤镜，并以小窗显示；
（3）识别出光源中心，并返回光源中心坐标；
（4）在界面上反映出水下机器人的运动状态，各个状态见图1中的标注。
程序运行界面如下：
![输入图片说明](https://gitee.com/uploads/images/2018/0119/092446_429ed95f_1477507.png "带姿态显示的运行界面.png")

3、软件程序介绍：
    程序主要包括main函数、VideoPlayer类和MainWindow类。其中:main函数完成字符编码格式的设置，以及申请MainWindow类的对象，并显示。下面详细介绍其他的两个类。

3.1 VideoPlayer类
    VideoPlayer类公有继承自QThread类（Qt的线程类，是一个与平台无关的线程类，线程的启动通过调用run()函数实现）。在VideoPlayer类中主要包括摄像头视频流的解码和光源的识别。
（1）视频流的解码
	摄像头视频流的解码利用了FFmpeg开源库，此开源库在QThread的run()函数中完成解码工作。首先通过访问视频流的地址（在本例中地址为摄像头的IP地址rtsp://admin:admin@192.168.0.18:554/h264/ch1/main/av_stream）并打开，提取出其中的视频流（忽略音频流）， 然后利用解码器解码，最后将解码后的YUV数据转化成RGB32格式的数据。利用Qt中的QImage加载RGB数据，复制两份，一份发送给MainWindow类显示；对于另一份，提取出其中的R（红色）数据后，发送给MainWindow类显示。在run()函数的最后，将此次解码的视频资源释放掉，防止内存的上升。
（2）光源的识别
    在VideoPlayer类的run()函数中，利用QtConcurrent::run()在单独的一个线程中运行光源识别函数Indentificate()。语句如下：
QFuture<void> future = QtConcurrent::run(Indentificate, InImage,width,height);
上述语句中，Indentificate为光源识别函数名，”InImage,width,height”为函数的参数，并无返回值。
    在光源识别函数中，首先根据设定的阈值，将图像二值化，那么此时表示一幅图像的矩阵剧变成了0-1矩阵，在此例中摄像头的分辨率为1280x720，从而为一个1280x720的0-1矩阵。然后，根据下面的方法寻找光源坐标（在实际应用时，探照灯光源为圆形或椭圆形）。

![输入图片说明](https://gitee.com/uploads/images/2018/0119/092556_684bffc3_1477507.png "二值化图像.png")

Step 1: 将图像二值化，图像矩阵变为0-1矩阵；
Step 2: 求0-1图像矩阵每行和每列的和，分别存放于变量sum_hang和sum_lie（两者初值为0）中；
Step 3: 分别寻找每行和每列的最大值所在的行数和列数，若找到的最大值所在行（列）的sum_hang（sum_lie）下一行（列）或下几行（列）相等，那么说明此时摄像头距离光源较近，连续几行或几列都为“亮”。此时返回连续几行或几列的中间行数或列数。否则，直接返回行数和列数。比如，如下图所示的情形。

![输入图片说明](https://gitee.com/uploads/images/2018/0119/092951_91be07f5_1477507.png "光源识别特殊情形.png")

    上图表示的是光源在下方具有连续的几列都为“亮”，那么则返回图示位置的索引值，作为横坐标。
    在此，说明一下图像的坐标系分布，以图像左上角为坐标原点，向下为y轴正方向，向右为x轴正方向。
3.2 MainWindow类
    MainWindow类公有继承自QMainWindow类（Qt自带的类，常用于窗口界面的设计）。在MainWindow类中，主要接收来自VideoPlayer类的图像信号，实现摄像头原始图像的显示及加红色滤镜图像的显示，以及水下机器人横滚角的表示。


/*------------------------------------------------------原始版本说明-----------------------------------------------------*/

# FFmpeg-QT实现摄像头rtsp实时显示
1. 程序运行平台：（1）win10 64bit         （2）Qt Creator 4.3.1
2. 程序需要的库：（1）Qt 5.9.1(MSVC 2015,32bit) （2）FFmpeg 2.5.2
3. 程序流程图：
	程序流程图如图1所示，图中所示的主函数部分主要完成界面的构建、播放线程的建立以及参考坐标系的建立。图1展示了整个程序的运行流程。

![图1 程序流程图](https://git.oschina.net/uploads/images/2017/0905/143250_0efc807a_1477507.jpeg "视频播放流程图.jpg")
 
4. 程序界面：
	程序运行界面如图2所示。

 ![图2 程序运行界面](https://git.oschina.net/uploads/images/2017/0905/143322_08a2b5af_1477507.jpeg "运行界面.jpg")

5. 主要功能：
	该界面主要实现四个功能：
（1）.读取摄像头视频流（rtsp），并实时显示到主界面上（注：存在0.7s左右的延时，延时测试过程如图3所示）；

 ![图3 延时测试过程](https://git.oschina.net/uploads/images/2017/0905/143346_70845a4b_1477507.png "延时测试.png")

（2）.将rtsp视频流经过FFmpeg解码后的YUV数据转化成RGB32数据，提取其中的R（红色）通道，并在界面中的小窗显示（如图2中的左上角部分）；
（3）.将水下机器人的横滚角反映在界面上（如图2中，中间部分的虚线“十字”为水平和竖直参考位置；实线“十字”为横滚运动后机器人相对参考位置的角度变化，图示为模拟横滚角为10度的情形）。
（4）.若程序掉电，再次上电后能够自动地建立连接。


